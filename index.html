from flask import Flask, request, jsonify, render_template_string, send_file, url_for
import os
import io
import json
import uuid
import time
import threading
from datetime import datetime
from PIL import Image, ImageDraw, ImageFont

APP_TITLE = "Personalized Fairy Tale Generator"

app = Flask(_name_)
app.secret_key = os.environ.get("FLASK_SECRET_KEY", "change-me-in-prod")
app.config['MAX_CONTENT_LENGTH'] = 15 * 1024 * 1024  # 15MB upload limit

BASE_DIR = os.path.abspath(os.path.dirname(_file_))
UPLOAD_DIR = os.path.join(BASE_DIR, "uploads")
OUTPUT_DIR = os.path.join(BASE_DIR, "outputs")
os.makedirs(UPLOAD_DIR, exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)

ALLOWED_EXTENSIONS = {"png", "jpg", "jpeg", "webp"}

JOBS = {}

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>''' + APP_TITLE + '''</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f5f7fb; }
        .container { max-width: 960px; margin: 0 auto; padding: 24px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.08); padding: 24px; }
        h1 { margin: 0 0 8px 0; font-size: 28px; color: #222; }
        p.sub { margin: 0 0 20px 0; color: #666; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; }
        label { font-weight: 600; color: #333; display: block; margin-bottom: 8px; }
        input[type=file], select { padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; width: 100%; }
        .radios { display: flex; gap: 16px; flex-wrap: wrap; }
        .radio { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 999px; cursor: pointer; }
        .actions { display: flex; align-items: center; gap: 12px; margin-top: 4px; }
        button.primary { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 700; }
        button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress { display: none; margin-top: 18px; }
        .bar-wrap { width: 100%; background: #eef1f6; border-radius: 999px; overflow: hidden; height: 12px; }
        .bar { height: 12px; width: 0%; background: linear-gradient(90deg, #00c9ff, #92fe9d); transition: width 0.3s ease; }
        .status { margin-top: 8px; color: #444; font-weight: 600; }
        .success { color: #1b8f3a; font-weight: 700; }
        .error { color: #b00020; font-weight: 700; }
        .dl { margin-top: 12px; display: none; }
        .hint { font-size: 12px; color: #6b7280; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 720px) { .two-col { grid-template-columns: 1fr; } }
    </style>
    </head>
<body>
    <div class="container">
        <div class="card">
            <h1>''' + APP_TITLE + '''</h1>
            <p class="sub">Generate a 12-page 8.5" × 8.5" full-bleed fairy tale PDF featuring your child.</p>

            <div class="grid">
                <div>
                    <label>Child Photo (Required)</label>
                    <input id="photo" type="file" accept="image/*" />
                    <div class="hint">Use a clear, front-facing photo for best results.</div>
                </div>

                <div class="two-col">
                    <div>
                        <label>Story (Required)</label>
                        <div class="radios">
                            <label class="radio"><input type="radio" name="story" value="lrrh"> Little Red Riding Hood</label>
                            <label class="radio"><input type="radio" name="story" value="jack"> Jack and the Beanstalk</label>
                        </div>
                    </div>
                    <div>
                        <label>Gender (Required)</label>
                        <div class="radios">
                            <label class="radio"><input type="radio" name="gender" value="boy"> Boy</label>
                            <label class="radio"><input type="radio" name="gender" value="girl"> Girl</label>
                        </div>
                    </div>
                </div>

                <div class="two-col">
                    <div>
                        <label>Child Name (Optional)</label>
                        <input id="childName" placeholder="e.g., Alex" style="padding:10px;border:2px solid #e9ecef;border-radius:8px;width:100%"/>
                    </div>
                    <div>
                        <label>Style (Fixed for MVP)</label>
                        <select id="style">
                            <option value="disney-brave" selected>Disney Brave style (consistent)</option>
                        </select>
                    </div>
                </div>

                <div class="actions">
                    <button id="go" class="primary">Generate Story</button>
                    <span id="reqErr" class="error" style="display:none"></span>
                </div>

                <div id="progress" class="progress">
                    <div class="bar-wrap"><div id="bar" class="bar"></div></div>
                    <div id="status" class="status">Preparing...</div>
                    <div id="done" class="success" style="display:none">Completed!</div>
                    <div id="err" class="error" style="display:none"></div>
                    <div id="dl" class="dl"><a id="dllink" class="primary" href="#">Download Your Book</a></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const el = (id) => document.getElementById(id);
        const go = el('go');
        const progressWrap = el('progress');
        const bar = el('bar');
        const statusEl = el('status');
        const doneEl = el('done');
        const errEl = el('err');
        const dlWrap = el('dl');
        const dlLink = el('dllink');
        const reqErr = el('reqErr');

        let jobId = null;
        let pollTimer = null;

        function getRadio(name) {
            const n = document.querySelector('input[name="' + name + '"]:checked');
            return n ? n.value : null;
        }

        async function start() {
            reqErr.style.display = 'none';
            errEl.style.display = 'none';
            doneEl.style.display = 'none';
            dlWrap.style.display = 'none';
            bar.style.width = '0%';
            statusEl.textContent = 'Preparing...';

            const photo = document.getElementById('photo').files[0];
            const story = getRadio('story');
            const gender = getRadio('gender');
            const childName = document.getElementById('childName').value || '';
            const style = document.getElementById('style').value;

            if (!photo || !story || !gender) {
                reqErr.textContent = 'Please upload a photo, select a story and gender.';
                reqErr.style.display = 'inline-block';
                return;
            }

            go.disabled = true;
            progressWrap.style.display = 'block';

            const form = new FormData();
            form.append('photo', photo);
            form.append('story', story);
            form.append('gender', gender);
            form.append('child_name', childName);
            form.append('style', style);

            try {
                const res = await fetch('/generate', { method: 'POST', body: form });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to start job');
                jobId = data.job_id;
                poll();
            } catch (e) {
                errEl.textContent = e.message;
                errEl.style.display = 'block';
                go.disabled = false;
            }
        }

        async function poll() {
            if (!jobId) return;
            try {
                const res = await fetch('/progress/' + jobId);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Error');
                bar.style.width = data.percent + '%';
                statusEl.textContent = data.message;
                if (data.state === 'completed') {
                    doneEl.style.display = 'block';
                    dlLink.href = data.download_url;
                    dlWrap.style.display = 'block';
                    go.disabled = false;
                    jobId = null;
                    return;
                }
                if (data.state === 'error') {
                    errEl.textContent = data.error || 'An error occurred';
                    errEl.style.display = 'block';
                    go.disabled = false;
                    jobId = null;
                    return;
                }
                pollTimer = setTimeout(poll, 1200);
            } catch (e) {
                errEl.textContent = e.message;
                errEl.style.display = 'block';
                go.disabled = false;
                jobId = null;
            }
        }

        go.addEventListener('click', start);
    </script>
</body>
</html>
'''


def set_progress(job_id: str, percent: int, message: str):
    job = JOBS.get(job_id)
    if not job:
        return
    job["percent"] = max(0, min(100, int(percent)))
    job["message"] = message


def fail_job(job_id: str, error_message: str):
    job = JOBS.get(job_id)
    if not job:
        return
    job["state"] = "error"
    job["error"] = error_message
    job["message"] = "Error"
    job["percent"] = job.get("percent", 0)


def allowed_file(filename: str) -> bool:
    if not filename or "." not in filename:
        return False
    ext = filename.rsplit(".", 1)[1].lower()
    return ext in ALLOWED_EXTENSIONS


def generate_story_json(story_key: str, gender: str, child_name: str, features: dict) -> dict:
    title_child = child_name.strip() if child_name else "Your Child"
    story_title = ""
    base_pages = []

    if story_key == "lrrh":
        story_title = f"Little Red Riding Hood starring {title_child}"
        base_pages = [
            (1, "Cover page with child as Little Red Riding Hood", f"Little Red Riding Hood starring {title_child}"),
            (2, "Mother gives basket to child", "One day, Mama gave Little Red a basket of goodies for Grandma."),
            (3, "Child sets off into the woods with basket", "With a smile, {name} skipped down the forest path, humming a tune."),
            (4, "Friendly animals watch from trees", "Birds chirped and squirrels peeked as the trees whispered hello."),
            (5, "The wolf appears on the path", "A curious wolf asked where {name} was going with such a lovely basket."),
            (6, "Child takes the safe path", "{name} remembered Mama's rules and stayed on the path, brave and kind."),
            (7, "Grandma's cottage in the clearing", "Soon, a cozy cottage with flowers by the window came into view."),
            (8, "Grandma welcomes child warmly", "Grandma hugged {name} tight and thanked them for the treats."),
            (9, "Wolf tries to sneak but is scared away", "A creak at the door! But a loud bark from a neighbor's dog sent the wolf running."),
            (10, "Sharing the goodies and tea", "They laughed together and shared tea, safe and happy."),
            (11, "Walk home through golden sunset", "Hand in hand, they waved goodbye as the sky turned rosy gold."),
            (12, "Back home safe, lesson learned", "That day, {name} learned that courage and kindness make every journey bright.")
        ]
    else:
        story_title = f"Jack and the Beanstalk starring {title_child}"
        base_pages = [
            (1, "Cover page with child as Jack beside magic beans", f"Jack and the Beanstalk starring {title_child}"),
            (2, "Mother gives task to sell cow", "{name} promised to help their family, brave and hopeful."),
            (3, "Stranger trades cow for magic beans", "Mysterious beans sparkled with a swirl of emerald light."),
            (4, "Beanstalk grows to the sky overnight", "By morning, a giant beanstalk reached the clouds!"),
            (5, "Climbing the beanstalk with steady courage", "Step by step, {name} climbed higher than the birds."),
            (6, "Castle in the clouds", "A grand castle shimmered above the fluffy clouds."),
            (7, "Friendly giant's kitchen with golden harp", "A gentle giant hummed while a golden harp sang softly."),
            (8, "{name} finds a golden egg", "A goose laid a golden egg that gleamed like sunshine."),
            (9, "The giant notices", "Thump, thump! The giant's footsteps made the clouds bounce."),
            (10, "Quick escape down the beanstalk", "{name} hurried down, clutching the harp with care."),
            (11, "Cutting the beanstalk safely", "With a careful chop, the beanstalk toppled away from the town."),
            (12, "Family celebrates with hope", "Thanks to {name}, the family found joy and plenty.")
        ]

    eye = features.get("eye_color", "brown")
    hair = features.get("hair_color", "brown")
    style = "Disney Brave style, consistent across pages"
    role = "hero"
    if story_key == "lrrh":
        outfit = "red hooded cloak, picnic basket"
    else:
        outfit = "simple village clothes, adventurous spirit"

    pages = []
    for num, scene, text in base_pages:
        text_filled = text.replace("{name}", title_child)
        prompt = (
            f"Square 8.5in illustration, full-bleed. {style}. "
            f"Main character is a {gender} child ({role}) with {hair} hair and {eye} eyes, consistent face across pages, "
            f"wearing {outfit}. Scene: {scene}. Include page text embedded in the image: '{text_filled}'. "
            f"Keep artistic style, lighting, and character identity consistent."
        )
        pages.append({
            "page_number": num,
            "scene_description": scene,
            "text": text_filled,
            "image_prompt": prompt
        })

    return {"story_title": story_title, "pages": pages}


def extract_simple_features(image_path: str) -> dict:
    return {"eye_color": "brown", "hair_color": "brown"}


def retry_call(fn, retries=3, backoff=1.5, first_delay=0.0):
    delay = first_delay
    last_exc = None
    for attempt in range(retries):
        try:
            if delay > 0:
                time.sleep(delay)
            return fn()
        except Exception as exc:
            last_exc = exc
            delay = max(0.2, delay * backoff) if delay else 0.4
    if last_exc:
        raise last_exc


def ai_generate_image(prompt: str, size_px: int) -> Image.Image:
    # Placeholder for real AI provider integration, gated by env vars
    # Example env: IMAGE_API="openai" and OPENAI_API_KEY set
    # For MVP, fallback to local generation to avoid costs
    return generate_image_fallback(prompt, size_px)


def generate_image_fallback(prompt: str, size_px: int) -> Image.Image:
    img = Image.new("RGB", (size_px, size_px), color=(250, 248, 240))
    draw = ImageDraw.Draw(img)
    try:
        font_title = ImageFont.truetype("arial.ttf", 52)
        font_body = ImageFont.truetype("arial.ttf", 32)
    except Exception:
        font_title = ImageFont.load_default()
        font_body = ImageFont.load_default()

    draw.rectangle([0, 0, size_px - 1, size_px - 1], outline=(80, 80, 80), width=6)
    wrap = 60
    text = prompt[: size_px // 2]
    lines = []
    current = ""
    for word in text.split():
        if len(current) + len(word) + 1 <= wrap:
            current = (current + " " + word).strip()
        else:
            lines.append(current)
            current = word
    if current:
        lines.append(current)

    y = 80
    draw.text((80, y), "Illustration (MVP)", fill=(20, 20, 20), font=font_title)
    y += 80
    for line in lines[:18]:
        draw.text((80, y), line, fill=(40, 40, 40), font=font_body)
        y += 42

    return img


def generate_image_from_prompt(prompt: str, size_px: int = 2550) -> Image.Image:
    provider = os.environ.get("IMAGE_API", "fallback").lower()
    if provider == "fallback":
        return generate_image_fallback(prompt, size_px)
    # Wrap provider call in retries
    def call():
        return ai_generate_image(prompt, size_px)
    return retry_call(call, retries=3, backoff=1.8, first_delay=0.2)


def compile_pdf_square(images: list, out_path: str):
    rgb_images = []
    for img in images:
        if img.mode != "RGB":
            rgb_images.append(img.convert("RGB"))
        else:
            rgb_images.append(img)
    if not rgb_images:
        raise RuntimeError("No images to compile")
    first, rest = rgb_images[0], rgb_images[1:]
    first.save(out_path, save_all=True, append_images=rest, format="PDF")


def job_runner(job_id: str, photo_path: str, story: str, gender: str, child_name: str, style: str):
    try:
        set_progress(job_id, 3, "Analyzing uploaded image...")
        features = extract_simple_features(photo_path)
        time.sleep(0.2)

        set_progress(job_id, 10, "Generating story outline (JSON)...")
        story_json = generate_story_json(story, gender, child_name, features)
        time.sleep(0.2)

        pages = story_json["pages"]
        total = len(pages)
        imgs = []
        for idx, page in enumerate(pages, start=1):
            set_progress(job_id, 10 + int(80 * (idx - 0.5) / total), f"Creating page {idx} of {total}...")
            img = generate_image_from_prompt(page["image_prompt"], size_px=2550)
            imgs.append(img)
            time.sleep(0.15)

        set_progress(job_id, 92, "Compiling PDF (8.5in × 8.5in, full-bleed)...")
        out_name = f"{job_id}.pdf"
        out_path = os.path.join(OUTPUT_DIR, out_name)
        compile_pdf_square(imgs, out_path)

        set_progress(job_id, 100, "Done")
        JOBS[job_id]["state"] = "completed"
        JOBS[job_id]["output_path"] = out_path
        JOBS[job_id]["download_url"] = f"/download/{job_id}"
    except Exception as e:
        fail_job(job_id, str(e))
    finally:
        try:
            if photo_path and os.path.exists(photo_path):
                os.remove(photo_path)
        except Exception:
            pass


@app.route("/")
def home():
    return render_template_string(HTML_TEMPLATE)


@app.route("/generate", methods=["POST"])
def generate():
    try:
        if "photo" not in request.files:
            return jsonify({"success": False, "error": "Missing photo upload"}), 400
        f = request.files["photo"]
        if not f.filename:
            return jsonify({"success": False, "error": "No file selected"}), 400
        if not allowed_file(f.filename):
            return jsonify({"success": False, "error": "Invalid file type (png, jpg, jpeg, webp only)"}), 400

        story = request.form.get("story")
        gender = request.form.get("gender")
        child_name = request.form.get("child_name", "").strip()
        style = request.form.get("style", "disney-brave")

        if story not in {"lrrh", "jack"}:
            return jsonify({"success": False, "error": "Invalid story"}), 400
        if gender not in {"boy", "girl"}:
            return jsonify({"success": False, "error": "Invalid gender"}), 400

        job_id = str(uuid.uuid4())
        _, ext = os.path.splitext(f.filename)
        ext = (ext or "").lower()
        if ext.replace('.', '') not in ALLOWED_EXTENSIONS:
            ext = ".jpg"
        filename = f"{job_id}_photo{ext}"
        photo_path = os.path.join(UPLOAD_DIR, filename)
        f.save(photo_path)

        JOBS[job_id] = {
            "state": "running",
            "percent": 0,
            "message": "Starting...",
            "created": datetime.utcnow().isoformat()
        }

        t = threading.Thread(target=job_runner, args=(job_id, photo_path, story, gender, child_name, style), daemon=True)
        t.start()

        return jsonify({"success": True, "job_id": job_id})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500


@app.route("/progress/<job_id>")
def progress(job_id: str):
    job = JOBS.get(job_id)
    if not job:
        return jsonify({"success": False, "error": "Job not found"}), 404
    payload = {"success": True, "state": job.get("state", "running"), "percent": job.get("percent", 0), "message": job.get("message", "")}
    if job.get("state") == "completed":
        payload["download_url"] = job.get("download_url")
    if job.get("state") == "error":
        payload["error"] = job.get("error", "")
    return jsonify(payload)


@app.route("/download/<job_id>")
def download(job_id: str):
    job = JOBS.get(job_id)
    if not job or job.get("state") != "completed":
        return jsonify({"success": False, "error": "File not ready"}), 400
    path = job.get("output_path")
    if not path or not os.path.exists(path):
        return jsonify({"success": False, "error": "File missing"}), 404
    return send_file(path, as_attachment=True, download_name=f"storybook_{job_id}.pdf")


if _name_ == "_main_":
    print("Starting Personalized Fairy Tale Generator...")
    print("Open http://localhost:5000")
    port = int(os.environ.get("PORT", "5000"))
    app.run(host="0.0.0.0", port=port, debug=True)
